<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuswar - Recent Orders</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { padding-top: 76px; background-color: #f5f7fb; }
        .order-row:hover { background-color: rgba(67, 97, 238, 0.05); cursor: pointer; }
        .status-badge { min-width: 100px; }
        .modal-lg { max-width: 800px; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-gift"></i> Traditionalzz Kuswar
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="checkout.html">
                            <i class="fas fa-shopping-cart"></i> Checkout
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="orders.html">
                            <i class="fas fa-history"></i> Recent Orders
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="stats.html">
                            <i class="fas fa-chart-bar"></i> Stats
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-5 pt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-5 fw-bold text-primary">
                    <i class="fas fa-history"></i> Recent Orders
                </h1>
                <p class="lead">View and manage all customer orders</p>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchOrders" 
                                       placeholder="Search by Order ID, Name, Phone...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-control" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="Paid">Paid</option>
                                    <option value="Unpaid">Unpaid</option>
                                    <option value="Cash on Delivery">Cash on Delivery</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control" id="dateFilter">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="loadOrders()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Orders Table -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Date & Time</th>
                                        <th>Customer</th>
                                        <th>Items</th>
                                        <th class="text-end">Amount</th>
                                        <th>Status</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTable">
                                    <tr>
                                        <td colspan="7" class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2">Loading orders...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer bg-white border-top-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted" id="ordersCount">Loading...</small>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadOrders()">
                                        <i class="fas fa-redo"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="orderDetailsModalLabel">
                        <i class="fas fa-receipt"></i> Order Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailsContent">
                    Loading order details...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printOrderDetails()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        const CONFIG = {
            API_BASE_URL: "https://kuswar-backend.onrender.com"
        };

        let allOrders = [];
        let currentFilteredOrders = [];

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Search as you type
            document.getElementById('searchOrders').addEventListener('input', filterOrders);
            
            // Filter on status change
            document.getElementById('statusFilter').addEventListener('change', filterOrders);
            
            // Filter on date change
            document.getElementById('dateFilter').addEventListener('change', filterOrders);
            
            // Set today's date as default in date filter
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFilter').value = today;
        }

        // Load orders from API
        async function loadOrders() {
            try {
                showLoading(true);
                
                // Get filter values
                const statusFilter = document.getElementById('statusFilter').value;
                const dateFilter = document.getElementById('dateFilter').value;
                
                // Build query parameters
                let params = new URLSearchParams();
                
                if (statusFilter) {
                    params.append('payment_status', statusFilter);
                }
                
                if (dateFilter) {
                    params.append('from_date', dateFilter);
                    params.append('to_date', dateFilter);
                }
                
                // Fetch orders from API
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/orders?${params.toString()}`);
                const data = await response.json();
                
                if (data.success) {
                    allOrders = data.data || [];
                    // Normalize time fields - handle both "OrderTime" & "Ordertime"
                    allOrders = allOrders.map(order => {
                        // If Ordertime exists but OrderTime doesn't, copy it
                        if (order.Ordertime && !order.OrderTime) {
                            order.OrderTime = order.Ordertime;
                        }
                        // Also make sure we have both uppercase and lowercase versions
                        if (order.OrderTime && !order.Ordertime) {
                            order.Ordertime = order.OrderTime;
                        }
                        return order;
                    });
                    
                    currentFilteredOrders = [...allOrders];
                    renderOrdersTable();
                    updateOrdersCount();
                    showNotification(`Loaded ${allOrders.length} orders`, 'success');
                } else {
                    throw new Error(data.error || 'Failed to load orders');
                }
                
            } catch (error) {
                console.error('Error loading orders:', error);
                showNotification(`Error: ${error.message}`, 'danger');
                renderOrdersTable(); // This will show error state
            } finally {
                showLoading(false);
            }
        }

        // Filter orders based on current filters
        function filterOrders() {
            const searchTerm = document.getElementById('searchOrders').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            currentFilteredOrders = allOrders.filter(order => {
                // Search filter
                if (searchTerm) {
                    const matchesSearch = 
                        (order.OrderID && order.OrderID.toLowerCase().includes(searchTerm)) ||
                        (order.CustomerName && order.CustomerName.toLowerCase().includes(searchTerm)) ||
                        (order.Phone && order.Phone.toLowerCase().includes(searchTerm));
                    
                    if (!matchesSearch) return false;
                }
                
                // Status filter (already handled by API, but we apply again for search compatibility)
                if (statusFilter && order.PaymentStatus !== statusFilter) {
                    return false;
                }
                
                // Date filter (already handled by API)
                if (dateFilter && order.OrderDate !== dateFilter) {
                    return false;
                }
                
                return true;
            });
            
            renderOrdersTable();
            updateOrdersCount();
        }

        // Render orders table
        function renderOrdersTable() {
            const ordersTable = document.getElementById('ordersTable');
            
            if (!currentFilteredOrders || currentFilteredOrders.length === 0) {
                ordersTable.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No orders found</h5>
                            <p class="text-muted small">Try changing your filters or check back later</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadOrders()">
                                <i class="fas fa-redo"></i> Refresh
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort orders by date (newest first)
            const sortedOrders = [...currentFilteredOrders].sort((a, b) => {
                const dateA = new Date(`${a.OrderDate} ${a.OrderTime || a.Ordertime || ''}`);
                const dateB = new Date(`${b.OrderDate} ${b.OrderTime || b.Ordertime || ''}`);
                return dateB - dateA;
            });
            
            let tableHTML = '';
            
            sortedOrders.forEach(order => {
                const orderDate = new Date(order.OrderDate);
                const formattedDate = orderDate.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                
                // Get time from either OrderTime or Ordertime field
                const time = order.OrderTime || order.Ordertime || 'N/A';
                
                // Format the time to HH:MM:SS if it exists
                let formattedTime = time;
                if (time !== 'N/A') {
                    // Try to parse and format the time
                    try {
                        const timeParts = time.split(':');
                        if (timeParts.length >= 2) {
                            formattedTime = `${timeParts[0]}:${timeParts[1]}`;
                            if (timeParts.length === 3) {
                                formattedTime += `:${timeParts[2]}`;
                            }
                        }
                    } catch (e) {
                        console.log('Error formatting time:', e);
                    }
                }
                
                // Format items list
                let itemsList = '';
                if (order.items && order.items.length > 0) {
                    const displayedItems = order.items.slice(0, 2);
                    itemsList = displayedItems.map(item => 
                        `<div class="small">${item.ProductName || 'Product'} × ${item.Quantity || 1}</div>`
                    ).join('');
                    
                    if (order.items.length > 2) {
                        itemsList += `<div class="small text-primary">+${order.items.length - 2} more items</div>`;
                    }
                } else {
                    itemsList = '<div class="small text-muted">No items</div>';
                }
                
                // Status badge styling
                let statusClass = 'bg-secondary';
                if (order.PaymentStatus === 'Paid') {
                    statusClass = 'bg-success';
                } else if (order.PaymentStatus === 'Unpaid') {
                    statusClass = 'bg-warning text-dark';
                } else if (order.PaymentStatus === 'Cash on Delivery') {
                    statusClass = 'bg-info';
                }
           	 	// Delivery status badge 
            	const deliveryStatus = order.DeliveryStatus || 'Pending';
            	let deliveryStatusClass = 'bg-warning text-dark';
            	if (deliveryStatus === 'Delivered') {
                	deliveryStatusClass = 'bg-success';
            	} else if (deliveryStatus === 'Cancelled') {
                	deliveryStatusClass = 'bg-danger';
            	} else if (deliveryStatus === 'In Transit') {
                	deliveryStatusClass = 'bg-info';
            	}
                
            tableHTML += `
                <tr class="order-row" onclick="viewOrderDetails('${order.OrderID}')">
                    <td>
                        <span class="badge bg-primary">#${order.OrderID}</span>
                    </td>
                    <td>
                        <div>${formattedDate}</div>
                        <small class="text-muted">${formattedTime}</small>
                    </td>
                    <td>
                        <strong>${order.CustomerName || 'N/A'}</strong>
                        <div class="small text-muted">${order.Phone || 'N/A'}</div>
                        <div class="small">${order.CustomerCity || ''} - ${order.CustomerArea || ''}</div>
                    </td>
                    <td>${itemsList}</td>
                    <td class="text-end">
                        <strong class="text-success">₹${(order.TotalAmount || 0).toFixed(2)}</strong>
                    </td>
                    <td>
                        <div>
                            <span class="badge ${statusClass} status-badge d-inline-block text-center mb-1">
                                ${order.PaymentStatus || 'Unknown'}
                            </span>
                            <br>
                            <span class="badge ${deliveryStatusClass} status-badge d-inline-block text-center">
                                ${deliveryStatus}
                            </span>
                        </div>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="event.stopPropagation(); viewOrderDetails('${order.OrderID}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
            `;
            });
            
            ordersTable.innerHTML = tableHTML;
        }

        // Update orders count
        function updateOrdersCount() {
            const ordersCount = document.getElementById('ordersCount');
            if (ordersCount) {
                ordersCount.textContent = `Showing ${currentFilteredOrders.length} of ${allOrders.length} orders`;
            }
        }

        // View order details
        async function viewOrderDetails(orderId) {
            try {
                // Find the order in filtered orders
                const order = currentFilteredOrders.find(o => o.OrderID === orderId);
                
                if (!order) {
                    // Try to fetch single order from API
                    const response = await fetch(`${CONFIG.API_BASE_URL}/api/orders?phone=&payment_status=&from_date=&to_date=`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const allOrders = data.data || [];
                        const foundOrder = allOrders.find(o => o.OrderID === orderId);
                        if (foundOrder) {
                            showOrderDetailsModal(foundOrder);
                        } else {
                            throw new Error('Order not found');
                        }
                    } else {
                        throw new Error(data.error || 'Failed to load order');
                    }
                } else {
                    showOrderDetailsModal(order);
                }
                
            } catch (error) {
                console.error('Error loading order details:', error);
                showNotification(`Error: ${error.message}`, 'danger');
            }
        }

        // Show order details in modal
        function showOrderDetailsModal(order) {
            // Format order date
            const orderDate = new Date(order.OrderDate);
            const formattedDate = orderDate.toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            // Get time from either OrderTime or Ordertime field
            const time = order.OrderTime || order.Ordertime || 'N/A';
            
            // Format the time properly
            let formattedTime = time;
            if (time !== 'N/A') {
                try {
                    const timeParts = time.split(':');
                    if (timeParts.length >= 2) {
                        formattedTime = `${timeParts[0].padStart(2, '0')}:${timeParts[1].padStart(2, '0')}`;
                        if (timeParts.length === 3) {
                            formattedTime += `:${timeParts[2].padStart(2, '0')}`;
                        }
                    }
                } catch (e) {
                    console.log('Error formatting time:', e);
                }
            }
            
            // Calculate item totals
            const itemsHTML = order.items && order.items.length > 0 ? order.items.map(item => {
                const itemTotal = (item.Quantity || 1) * (item.UnitPrice || 0);
                return `
                    <tr>
                        <td>${item.ProductName || 'Product'}</td>
                        <td class="text-center">${item.Quantity || 1}</td>
                        <td class="text-end">₹${(item.UnitPrice || 0).toFixed(2)}</td>
                        <td class="text-end">₹${itemTotal.toFixed(2)}</td>
                    </tr>
                `;
            }).join('') : '<tr><td colspan="4" class="text-center">No items</td></tr>';
            
            // Status badge
            let statusClass = 'bg-secondary';
            let statusText = order.PaymentStatus || 'Unknown';
            if (order.PaymentStatus === 'Paid') {
                statusClass = 'bg-success';
            } else if (order.PaymentStatus === 'Unpaid') {
                statusClass = 'bg-warning text-dark';
            } else if (order.PaymentStatus === 'Cash on Delivery') {
                statusClass = 'bg-info';
            }
            
            // Build modal content
            const modalContent = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">ORDER INFORMATION</h6>
                        <div class="mb-3">
                            <strong>Order ID:</strong> ${order.OrderID}<br>
                            <strong>Date:</strong> ${formattedDate}<br>
                            <strong>Time:</strong> ${formattedTime}<br>
                            <strong>Source:</strong> ${order.OrderSource || 'Website'}<br>
                            <strong>Status:</strong> <span class="badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">CUSTOMER INFORMATION</h6>
                        <div class="mb-3">
                            <strong>Name:</strong> ${order.CustomerName || 'N/A'}<br>
                            <strong>Phone:</strong> ${order.Phone || 'N/A'}<br>
                            <strong>Address:</strong> ${order.CustomerArea || ''}, ${order.CustomerCity || ''}<br>
                            <strong>Customer ID:</strong> ${order.CustomerID || 'N/A'}
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <h6 class="text-muted">ORDER ITEMS</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th class="text-center">Qty</th>
                                <th class="text-end">Price</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Total Amount:</strong></td>
                                <td class="text-end"><strong class="text-success">₹${(order.TotalAmount || 0).toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                ${order.notes ? `
                    <div class="alert alert-light mt-3">
                        <strong>Notes:</strong> ${order.notes}
                    </div>
                ` : ''}
                
                ${order.DeliveryDate ? `
                    <div class="alert alert-info mt-3">
                        <strong>Delivery Date:</strong> ${order.DeliveryDate}
                    </div>
                ` : ''}
                
                ${order.PaidTo ? `
                    <div class="alert alert-success mt-3">
                        <strong>Payment Received By:</strong> ${order.PaidTo}
                    </div>
                ` : ''}
            `;
            
            document.getElementById('orderDetailsModalLabel').textContent = `Order #${order.OrderID}`;
            document.getElementById('orderDetailsContent').innerHTML = modalContent;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();
        }

        // Print order details
        function printOrderDetails() {
            const printContent = document.getElementById('orderDetailsContent').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div class="container mt-4">
                    <h2>Order Invoice</h2>
                    <hr>
                    ${printContent}
                </div>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
            
            // Re-initialize modal
            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();
        }

        // Show loading state
        function showLoading(isLoading) {
            const ordersTable = document.getElementById('ordersTable');
            if (isLoading) {
                ordersTable.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading orders...</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Create toast element
            const toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.id = toastId;
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            document.body.appendChild(toastContainer);
            
            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 3000
            });
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', function() {
                toastContainer.remove();
            });
        }

                function showOrderDetailsModal(order) {
            // Format order date
            const orderDate = new Date(order.OrderDate);
            const formattedDate = orderDate.toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Get time from either OrderTime or Ordertime field
            const time = order.OrderTime || order.Ordertime || 'N/A';
            
            // Format the time properly
            let formattedTime = time;
            if (time !== 'N/A') {
                try {
                    const timeParts = time.split(':');
                    if (timeParts.length >= 2) {
                        formattedTime = `${timeParts[0].padStart(2, '0')}:${timeParts[1].padStart(2, '0')}`;
                        if (timeParts.length === 3) {
                            formattedTime += `:${timeParts[2].padStart(2, '0')}`;
                        }
                    }
                } catch (e) {
                    console.log('Error formatting time:', e);
                }
            }
            
            // Get delivery status
            const deliveryStatus = order.DeliveryStatus || 'Pending';
            
            // Delivery status badge styling
            let deliveryStatusClass = 'bg-warning text-dark';
            if (deliveryStatus === 'Delivered') {
                deliveryStatusClass = 'bg-success';
            } else if (deliveryStatus === 'Cancelled') {
                deliveryStatusClass = 'bg-danger';
            } else if (deliveryStatus === 'In Transit') {
                deliveryStatusClass = 'bg-info';
            } else if (deliveryStatus === 'Pending') {
                deliveryStatusClass = 'bg-warning text-dark';
            }
            
            // Calculate item totals
            const itemsHTML = order.items && order.items.length > 0 ? order.items.map(item => {
                const itemTotal = (item.Quantity || 1) * (item.UnitPrice || 0);
                return `
                    <tr>
                        <td>${item.ProductName || 'Product'}</td>
                        <td class="text-center">${item.Quantity || 1}</td>
                        <td class="text-end">₹${(item.UnitPrice || 0).toFixed(2)}</td>
                        <td class="text-end">₹${itemTotal.toFixed(2)}</td>
                    </tr>
                `;
            }).join('') : '<tr><td colspan="4" class="text-center">No items</td></tr>';
            
            // Payment status badge
            let statusClass = 'bg-secondary';
            let statusText = order.PaymentStatus || 'Unknown';
            if (order.PaymentStatus === 'Paid') {
                statusClass = 'bg-success';
            } else if (order.PaymentStatus === 'Unpaid') {
                statusClass = 'bg-warning text-dark';
            } else if (order.PaymentStatus === 'Cash on Delivery') {
                statusClass = 'bg-info';
            }
            
            // Store order ID globally for update function
            window.currentOrderId = order.OrderID;
            
            // Build modal content
            const modalContent = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">ORDER INFORMATION</h6>
                        <div class="mb-3">
                            <strong>Order ID:</strong> ${order.OrderID}<br>
                            <strong>Date:</strong> ${formattedDate}<br>
                            <strong>Time:</strong> ${formattedTime}<br>
                            <strong>Source:</strong> ${order.OrderSource || 'Website'}<br>
                            <strong>Payment Status:</strong> <span class="badge ${statusClass}">${statusText}</span><br>
                            <strong>Delivery Status:</strong> 
                            <span class="badge ${deliveryStatusClass}" id="deliveryStatusBadge">
                                ${deliveryStatus}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">CUSTOMER INFORMATION</h6>
                        <div class="mb-3">
                            <strong>Name:</strong> ${order.CustomerName || 'N/A'}<br>
                            <strong>Phone:</strong> ${order.Phone || 'N/A'}<br>
                            <strong>Address:</strong> ${order.CustomerArea || ''}, ${order.CustomerCity || ''}<br>
                            <strong>Customer ID:</strong> ${order.CustomerID || 'N/A'}
                        </div>
                    </div>
                </div>
                
                <!-- Delivery Status Update Section -->
                <div class="card mt-3 border-primary">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="mb-0"><i class="fas fa-truck"></i> Update Delivery Status</h6>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-success ${deliveryStatus === 'Delivered' ? 'active' : ''}" 
                                            onclick="updateDeliveryStatus('Delivered')">
                                        <i class="fas fa-check-circle"></i> Delivered
                                    </button>
                                    <button type="button" class="btn btn-outline-warning ${deliveryStatus === 'In Transit' ? 'active' : ''}" 
                                            onclick="updateDeliveryStatus('In Transit')">
                                        <i class="fas fa-shipping-fast"></i> In Transit
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ${deliveryStatus === 'Pending' ? 'active' : ''}" 
                                            onclick="updateDeliveryStatus('Pending')">
                                        <i class="fas fa-clock"></i> Pending
                                    </button>
                                    <button type="button" class="btn btn-outline-danger ${deliveryStatus === 'Cancelled' ? 'active' : ''}" 
                                            onclick="updateDeliveryStatus('Cancelled')">
                                        <i class="fas fa-times-circle"></i> Cancelled
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-control" id="deliveryStatusSelect">
                                    <option value="Pending" ${deliveryStatus === 'Pending' ? 'selected' : ''}>Pending</option>
                                    <option value="In Transit" ${deliveryStatus === 'In Transit' ? 'selected' : ''}>In Transit</option>
                                    <option value="Delivered" ${deliveryStatus === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                    <option value="Cancelled" ${deliveryStatus === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="updateDeliveryStatusFromSelect()">
                                <i class="fas fa-save"></i> Update Status
                            </button>
                            <small class="text-muted ms-2">Click a button above or select and update</small>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <h6 class="text-muted">ORDER ITEMS</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th class="text-center">Qty</th>
                                <th class="text-end">Price</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Total Amount:</strong></td>
                                <td class="text-end"><strong class="text-success">₹${(order.TotalAmount || 0).toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                ${order.notes ? `
                    <div class="alert alert-light mt-3">
                        <strong>Notes:</strong> ${order.notes}
                    </div>
                ` : ''}
                
                ${order.DeliveryDate ? `
                    <div class="alert alert-info mt-3">
                        <strong>Delivery Date:</strong> ${order.DeliveryDate}
                    </div>
                ` : ''}
                
                ${order.PaidTo ? `
                    <div class="alert alert-success mt-3">
                        <strong>Payment Received By:</strong> ${order.PaidTo}
                    </div>
                ` : ''}
            `;
                
            document.getElementById('orderDetailsModalLabel').textContent = `Order #${order.OrderID}`;
            document.getElementById('orderDetailsContent').innerHTML = modalContent;
                
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();
        }
        
        // Update delivery status from button click
        async function updateDeliveryStatus(newStatus) {
            try {
                if (!window.currentOrderId) {
                    showNotification('No order selected', 'warning');
                    return;
                }
                
                // Update the select dropdown to match
                document.getElementById('deliveryStatusSelect').value = newStatus;
                
                // Call the API to update status
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/orders/${window.currentOrderId}/delivery-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        delivery_status: newStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the badge
                    let badgeClass = 'bg-warning text-dark';
                    if (newStatus === 'Delivered') {
                        badgeClass = 'bg-success';
                    } else if (newStatus === 'Cancelled') {
                        badgeClass = 'bg-danger';
                    } else if (newStatus === 'In Transit') {
                        badgeClass = 'bg-info';
                    }
                    
                    document.getElementById('deliveryStatusBadge').className = `badge ${badgeClass}`;
                    document.getElementById('deliveryStatusBadge').textContent = newStatus;
                    
                    // Update active state of buttons
                    document.querySelectorAll('.btn-group .btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.textContent.includes(newStatus)) {
                            btn.classList.add('active');
                        }
                    });
                    
                    showNotification(`Delivery status updated to ${newStatus}`, 'success');
                    
                    // Refresh the orders list after a short delay
                    setTimeout(() => {
                        loadOrders();
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Failed to update status');
                }
                
            } catch (error) {
                console.error('Error updating delivery status:', error);
                showNotification(`Error: ${error.message}`, 'danger');
            }
        }
        
        // Update delivery status from select dropdown
        async function updateDeliveryStatusFromSelect() {
            const select = document.getElementById('deliveryStatusSelect');
            const newStatus = select.value;
            
            if (newStatus) {
                await updateDeliveryStatus(newStatus);
            }
        }

        // Make functions available globally
        window.loadOrders = loadOrders;
        window.filterOrders = filterOrders;
        window.viewOrderDetails = viewOrderDetails;
        window.printOrderDetails = printOrderDetails;
    </script>
</body>
</html>