<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuswar - Recent Orders</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { padding-top: 76px; background-color: #f5f7fb; }
        .order-row:hover { background-color: rgba(67, 97, 238, 0.05); cursor: pointer; }
        .status-badge { min-width: 100px; }
        .modal-lg { max-width: 800px; }
        .filter-btn.active { background-color: #0d6efd; color: white; }
        .table th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-gift"></i> Traditionalzz Kuswar
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="checkout.html">
                            <i class="fas fa-shopping-cart"></i> Checkout
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="orders.html">
                            <i class="fas fa-history"></i> Recent Orders
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="stats.html">
                            <i class="fas fa-chart-bar"></i> Stats
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-5 pt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-5 fw-bold text-primary">
                    <i class="fas fa-history"></i> Recent Orders
                </h1>
                <p class="lead">View and manage all customer orders</p>
            </div>
        </div>
        
        <!-- Advanced Filters -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="mb-0"><i class="fas fa-filter"></i> Advanced Filters</h5>
                    </div>
                    <div class="card-body">
                        <!-- Search -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="searchOrders" 
                                           placeholder="Search by Order ID, Customer Name, Phone, City, Area, Product...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearFilters()">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status Filters -->
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Payment Status</label>
                                <select class="form-control" id="paymentStatusFilter">
                                    <option value="">All Payments</option>
                                    <option value="Paid">Paid</option>
                                    <option value="Unpaid">Unpaid</option>
                                    <option value="Cash on Delivery">Cash on Delivery</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Delivery Status</label>
                                <select class="form-control" id="deliveryStatusFilter">
                                    <option value="">All Deliveries</option>
                                    <option value="Pending">Pending</option>
                                    <option value="In Transit">In Transit</option>
                                    <option value="Delivered">Delivered</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Order Date</label>
                                <input type="date" class="form-control" id="dateFilter">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Quick Actions</label>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="loadOrders()">
                                        <i class="fas fa-filter"></i> Apply Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Filter Buttons -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex flex-wrap gap-2">
                                    <small class="text-muted me-2">Quick Filters:</small>
                                    <button class="btn btn-sm btn-outline-success filter-btn" onclick="setFilter('payment', 'Paid')">
                                        <i class="fas fa-check-circle"></i> Paid Orders
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning filter-btn" onclick="setFilter('payment', 'Unpaid')">
                                        <i class="fas fa-exclamation-circle"></i> Unpaid Orders
                                    </button>
                                    <button class="btn btn-sm btn-outline-info filter-btn" onclick="setFilter('delivery', 'Delivered')">
                                        <i class="fas fa-truck"></i> Delivered
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary filter-btn" onclick="setFilter('delivery', 'Pending')">
                                        <i class="fas fa-clock"></i> Pending Delivery
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger filter-btn" onclick="setFilter('delivery', 'Cancelled')">
                                        <i class="fas fa-times-circle"></i> Cancelled
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Orders Table -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 600px;">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Date & Time</th>
                                        <th>Customer</th>
                                        <th>Items</th>
                                        <th class="text-end">Amount</th>
                                        <th>Payment Status</th>
                                        <th>Delivery Status</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTable">
                                    <tr>
                                        <td colspan="8" class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2">Loading orders...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="card-footer bg-white border-top-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted" id="ordersCount">Loading...</small>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="exportOrders()">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="loadOrders()">
                                        <i class="fas fa-redo"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="orderDetailsModalLabel">
                        <i class="fas fa-receipt"></i> Order Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailsContent">
                    Loading order details...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printOrderDetails()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        const CONFIG = {
            API_BASE_URL: "https://kuswar-backend.onrender.com"
        };

        let allOrders = [];
        let currentFilteredOrders = [];

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
            setupEventListeners();
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFilter').value = today;
        });

        // Setup event listeners
        function setupEventListeners() {
            // Real-time search as you type
            document.getElementById('searchOrders').addEventListener('input', function() {
                filterOrders();
            });
            
            // Filter on status change
            document.getElementById('paymentStatusFilter').addEventListener('change', filterOrders);
            document.getElementById('deliveryStatusFilter').addEventListener('change', filterOrders);
            document.getElementById('dateFilter').addEventListener('change', filterOrders);
            
            // Enter key in search
            document.getElementById('searchOrders').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filterOrders();
                }
            });
        }

        // Set quick filter
        function setFilter(type, value) {
            if (type === 'payment') {
                document.getElementById('paymentStatusFilter').value = value;
            } else if (type === 'delivery') {
                document.getElementById('deliveryStatusFilter').value = value;
            }
            filterOrders();
            
            // Highlight active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchOrders').value = '';
            document.getElementById('paymentStatusFilter').value = '';
            document.getElementById('deliveryStatusFilter').value = '';
            document.getElementById('dateFilter').value = '';
            
            // Clear active states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            filterOrders();
        }

        // Load orders from API
        async function loadOrders() {
            try {
                showLoading(true);
                
                // Get filter values
                const paymentStatusFilter = document.getElementById('paymentStatusFilter').value;
                const deliveryStatusFilter = document.getElementById('deliveryStatusFilter').value;
                const dateFilter = document.getElementById('dateFilter').value;
                
                // Build query parameters
                let params = new URLSearchParams();
                
                if (paymentStatusFilter) {
                    params.append('payment_status', paymentStatusFilter);
                }
                
                if (dateFilter) {
                    params.append('from_date', dateFilter);
                    params.append('to_date', dateFilter);
                }
                
                // Note: delivery_status filter is handled client-side since API might not support it
                
                // Fetch orders from API
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/orders?${params.toString()}`);
                const data = await response.json();
                
                if (data.success) {
                    allOrders = data.data || [];
                    // Normalize time field names
                    allOrders = allOrders.map(order => {
                        if (order.Ordertime && !order.OrderTime) {
                            order.OrderTime = order.Ordertime;
                        }
                        if (order.OrderTime && !order.Ordertime) {
                            order.Ordertime = order.OrderTime;
                        }
                        return order;
                    });
                    
                    currentFilteredOrders = [...allOrders];
                    filterOrders(); // Apply any existing filters
                    showNotification(`Loaded ${allOrders.length} orders`, 'success');
                } else {
                    throw new Error(data.error || 'Failed to load orders');
                }
                
            } catch (error) {
                console.error('Error loading orders:', error);
                showNotification(`Error: ${error.message}`, 'danger');
                renderOrdersTable(); // This will show error state
            } finally {
                showLoading(false);
            }
        }

        // Filter orders based on current filters
        function filterOrders() {
            const searchTerm = document.getElementById('searchOrders').value.toLowerCase();
            const paymentStatusFilter = document.getElementById('paymentStatusFilter').value;
            const deliveryStatusFilter = document.getElementById('deliveryStatusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            currentFilteredOrders = allOrders.filter(order => {
                // Search filter (search across multiple fields)
                if (searchTerm) {
                    const searchFields = [
                        order.OrderID || '',
                        order.CustomerName || '',
                        order.Phone || '',
                        order.CustomerCity || '',
                        order.CustomerArea || '',
                        // Also search in items
                        ...(order.items ? order.items.map(item => item.ProductName || '') : [])
                    ];
                    
                    const matchesSearch = searchFields.some(field => 
                        field.toString().toLowerCase().includes(searchTerm)
                    );
                    
                    if (!matchesSearch) return false;
                }
                
                // Payment status filter
                if (paymentStatusFilter && order.PaymentStatus !== paymentStatusFilter) {
                    return false;
                }
                
                // Delivery status filter (client-side)
                if (deliveryStatusFilter && order.DeliveryStatus !== deliveryStatusFilter) {
                    return false;
                }
                
                // Date filter
                if (dateFilter && order.OrderDate !== dateFilter) {
                    return false;
                }
                
                return true;
            });
            
            renderOrdersTable();
            updateOrdersCount();
        }

        // Render orders table
        function renderOrdersTable() {
            const ordersTable = document.getElementById('ordersTable');
            
            if (!currentFilteredOrders || currentFilteredOrders.length === 0) {
                ordersTable.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No orders found</h5>
                            <p class="text-muted small">Try changing your filters or check back later</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="loadOrders()">
                                <i class="fas fa-redo"></i> Refresh
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
        
            // Sort orders by date (newest first)
            const sortedOrders = [...currentFilteredOrders].sort((a, b) => {
                const dateA = new Date(`${a.OrderDate} ${a.OrderTime || a.Ordertime || ''}`);
                const dateB = new Date(`${b.OrderDate} ${b.OrderTime || b.Ordertime || ''}`);
                return dateB - dateA;
            });
            
            let tableHTML = '';
            
            sortedOrders.forEach(order => {
                const orderDate = new Date(order.OrderDate);
                const formattedDate = orderDate.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                
                // Get time from either OrderTime or Ordertime field
                const time = order.OrderTime || order.Ordertime || '';
                let formattedTime = 'N/A';
                if (time && time !== 'N/A') {
                    try {
                        const timeParts = time.split(':');
                        if (timeParts.length >= 2) {
                            formattedTime = `${timeParts[0]}:${timeParts[1]}`;
                        }
                    } catch (e) {
                        console.log('Error formatting time:', e);
                    }
                }
                
                // Format items list
                let itemsList = '';
                if (order.items && order.items.length > 0) {
                    const displayedItems = order.items.slice(0, 2);
                    itemsList = displayedItems.map(item => 
                        `<div class="small">${item.ProductName || 'Product'} × ${item.Quantity || 1}</div>`
                    ).join('');
                    
                    if (order.items.length > 2) {
                        itemsList += `<div class="small text-primary">+${order.items.length - 2} more</div>`;
                    }
                } else {
                    itemsList = '<div class="small text-muted">No items</div>';
                }
                
                // Payment status badge styling
                let paymentStatusClass = 'bg-secondary';
                if (order.PaymentStatus === 'Paid') {
                    paymentStatusClass = 'bg-success';
                } else if (order.PaymentStatus === 'Unpaid') {
                    paymentStatusClass = 'bg-warning text-dark';
                } else if (order.PaymentStatus === 'Cash on Delivery') {
                    paymentStatusClass = 'bg-info';
                }
                
                // Delivery status badge styling
                const deliveryStatus = order.DeliveryStatus || 'Pending';
                let deliveryStatusClass = 'bg-warning text-dark';
                if (deliveryStatus === 'Delivered') {
                    deliveryStatusClass = 'bg-success';
                } else if (deliveryStatus === 'Cancelled') {
                    deliveryStatusClass = 'bg-danger';
                } else if (deliveryStatus === 'In Transit') {
                    deliveryStatusClass = 'bg-info';
                }
                
                tableHTML += `
                    <tr class="order-row" onclick="viewOrderDetails('${order.OrderID}')">
                        <td>
                            <span class="badge bg-primary">#${order.OrderID}</span>
                        </td>
                        <td>
                            <div>${formattedDate}</div>
                            <small class="text-muted">${formattedTime}</small>
                        </td>
                        <td>
                            <strong>${order.CustomerName || 'N/A'}</strong>
                            <div class="small text-muted">${order.Phone || 'N/A'}</div>
                            <div class="small">${order.CustomerCity || ''} - ${order.CustomerArea || ''}</div>
                        </td>
                        <td>${itemsList}</td>
                        <td class="text-end">
                            <strong class="text-success">₹${(order.TotalAmount || 0).toFixed(2)}</strong>
                        </td>
                        <td>
                            <div class="d-flex flex-column align-items-center">
                                <span class="badge ${paymentStatusClass} status-badge d-inline-block text-center mb-1">
                                    ${order.PaymentStatus || 'Unknown'}
                                </span>
                                ${order.PaymentStatus === 'Paid' && order.PaidTo ? `
                                    <small class="text-success">
                                        <i class="fas fa-user-check"></i> ${order.PaidTo}
                                    </small>
                                ` : ''}
                            </div>
                        </td>
                        <td>
                            <span class="badge ${deliveryStatusClass} status-badge d-inline-block text-center">
                                ${deliveryStatus}
                            </span>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="event.stopPropagation(); viewOrderDetails('${order.OrderID}')">
                                <i class="fas fa-edit"></i> Manage
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            ordersTable.innerHTML = tableHTML;
        }

        // Update orders count
        function updateOrdersCount() {
            const ordersCount = document.getElementById('ordersCount');
            if (ordersCount) {
                const total = allOrders.length;
                const filtered = currentFilteredOrders.length;
                if (total === filtered) {
                    ordersCount.textContent = `Showing ${total} orders`;
                } else {
                    ordersCount.textContent = `Showing ${filtered} of ${total} orders`;
                }
            }
        }

        // View order details
        async function viewOrderDetails(orderId) {
            try {
                // Find the order in filtered orders
                const order = currentFilteredOrders.find(o => o.OrderID === orderId);
                
                if (!order) {
                    throw new Error('Order not found in current view');
                }
                
                showOrderDetailsModal(order);
                
            } catch (error) {
                console.error('Error loading order details:', error);
                showNotification(`Error: ${error.message}`, 'danger');
            }
        }

        // Show order details in modal
        function showOrderDetailsModal(order) {
            // Format order date
            const orderDate = new Date(order.OrderDate);
            const formattedDate = orderDate.toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Get time from either OrderTime or Ordertime field
            const time = order.OrderTime || order.Ordertime || 'N/A';
            
            // Format the time properly
            let formattedTime = time;
            if (time !== 'N/A') {
                try {
                    const timeParts = time.split(':');
                    if (timeParts.length >= 2) {
                        formattedTime = `${timeParts[0].padStart(2, '0')}:${timeParts[1].padStart(2, '0')}`;
                        if (timeParts.length === 3) {
                            formattedTime += `:${timeParts[2].padStart(2, '0')}`;
                        }
                    }
                } catch (e) {
                    console.log('Error formatting time:', e);
                }
            }
            
            // Get delivery status
            const deliveryStatus = order.DeliveryStatus || 'Pending';
            
            // Store order ID globally for update functions
            window.currentOrderId = order.OrderID;
            window.currentOrder = order;
            
            // Build modal content
            const modalContent = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">ORDER INFORMATION</h6>
                        <div class="mb-3">
                            <strong>Order ID:</strong> ${order.OrderID}<br>
                            <strong>Date:</strong> ${formattedDate}<br>
                            <strong>Time:</strong> ${formattedTime}<br>
                            <strong>Source:</strong> ${order.OrderSource || 'Website'}<br>
                            <strong>Created By:</strong> ${order.CreatedBy || 'API'}<br>
                            <strong>Customer ID:</strong> ${order.CustomerID || 'N/A'}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">CUSTOMER INFORMATION</h6>
                        <div class="mb-3">
                            <strong>Name:</strong> ${order.CustomerName || 'N/A'}<br>
                            <strong>Phone:</strong> ${order.Phone || 'N/A'}<br>
                            <strong>City:</strong> ${order.CustomerCity || ''}<br>
                            <strong>Area:</strong> ${order.CustomerArea || ''}
                        </div>
                    </div>
                </div>
                
                <!-- Show existing Paid To information -->
                ${order.PaidTo ? `
                    <div class="alert alert-success" id="paidToDisplay">
                        <strong>Payment Received By:</strong> ${order.PaidTo}
                    </div>
                ` : ''}
                
                <!-- Status Update Cards -->
                <div class="row mt-3">
                    <!-- Payment Status Card -->
                    <div class="col-md-6">
                        <div class="card border-primary h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-credit-card"></i> Payment Status</h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <span id="paymentStatusBadge" class="badge ${order.PaymentStatus === 'Paid' ? 'bg-success' : order.PaymentStatus === 'Unpaid' ? 'bg-warning text-dark' : 'bg-info'} fs-6 p-2">
                                        ${order.PaymentStatus || 'Unknown'}
                                    </span>
                                </div>
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-success ${order.PaymentStatus === 'Paid' ? 'active' : ''}" 
                                            onclick="updatePaymentStatus('Paid')">
                                        <i class="fas fa-check-circle"></i> Paid
                                    </button>
                                    <button type="button" class="btn btn-outline-warning ${order.PaymentStatus === 'Unpaid' ? 'active' : ''}" 
                                            onclick="updatePaymentStatus('Unpaid')">
                                        <i class="fas fa-clock"></i> Unpaid
                                    </button>
                                    <button type="button" class="btn btn-outline-info ${order.PaymentStatus === 'Cash on Delivery' ? 'active' : ''}" 
                                            onclick="updatePaymentStatus('Cash on Delivery')">
                                        <i class="fas fa-money-bill-wave"></i> COD
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delivery Status Card -->
                    <div class="col-md-6">
                        <div class="card border-primary h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-truck"></i> Delivery Status</h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <span id="deliveryStatusBadge" class="badge ${deliveryStatus === 'Delivered' ? 'bg-success' : deliveryStatus === 'Pending' ? 'bg-warning text-dark' : deliveryStatus === 'In Transit' ? 'bg-info' : 'bg-danger'} fs-6 p-2">
                                        ${deliveryStatus}
                                    </span>
                                </div>
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-warning ${deliveryStatus === 'Pending' ? 'active' : ''}" 
                                            onclick="updateDeliveryStatus('Pending')">
                                        <i class="fas fa-clock"></i> Pending
                                    </button>
                                    <button type="button" class="btn btn-outline-info ${deliveryStatus === 'In Transit' ? 'active' : ''}" 
                                            onclick="updateDeliveryStatus('In Transit')">
                                        <i class="fas fa-shipping-fast"></i> In Transit
                                    </button>
                                    <button type="button" class="btn btn-outline-success ${deliveryStatus === 'Delivered' ? 'active' : ''}" 
                                            onclick="updateDeliveryStatus('Delivered')">
                                        <i class="fas fa-check-circle"></i> Delivered
                                    </button>
                                    <button type="button" class="btn btn-outline-danger ${deliveryStatus === 'Cancelled' ? 'active' : ''}" 
                                            onclick="updateDeliveryStatus('Cancelled')">
                                        <i class="fas fa-times-circle"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Rest of the modal content remains the same -->
                <hr>
                
                <h6 class="text-muted">ORDER ITEMS</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th class="text-center">Qty</th>
                                <th class="text-end">Price</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items && order.items.length > 0 ? order.items.map(item => {
                                const itemTotal = (item.Quantity || 1) * (item.UnitPrice || 0);
                                return `
                                    <tr>
                                        <td>${item.ProductName || 'Product'}</td>
                                        <td class="text-center">${item.Quantity || 1}</td>
                                        <td class="text-end">₹${(item.UnitPrice || 0).toFixed(2)}</td>
                                        <td class="text-end">₹${itemTotal.toFixed(2)}</td>
                                    </tr>
                                `;
                            }).join('') : '<tr><td colspan="4" class="text-center">No items</td></tr>'}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Total Amount:</strong></td>
                                <td class="text-end"><strong class="text-success">₹${(order.TotalAmount || 0).toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                ${order.notes ? `
                    <div class="alert alert-light mt-3">
                        <strong>Notes:</strong> ${order.notes}
                    </div>
                ` : ''}
                
                ${order.DeliveryDate ? `
                    <div class="alert alert-info mt-3">
                        <strong>Delivery Date:</strong> ${order.DeliveryDate}
                    </div>
                ` : ''}
                
                ${order.PaidTo ? `
                    <div class="alert alert-success mt-3">
                        <strong>Payment Received By:</strong> ${order.PaidTo}
                    </div>
                ` : ''}
            `;
            
            document.getElementById('orderDetailsModalLabel').textContent = `Order #${order.OrderID}`;
            document.getElementById('orderDetailsContent').innerHTML = modalContent;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();
        }

        // Update payment status
        async function updatePaymentStatus(newStatus) {
            try {
                if (!window.currentOrderId) {
                    showNotification('No order selected', 'warning');
                    return;
                }
                
                let paidTo = null;
                
                // If changing to "Paid", prompt for "Paid To"
                if (newStatus === 'Paid') {
                    // Check if there's already a Paid To value
                    const currentPaidTo = window.currentOrder.PaidTo || '';
                    
                    // Show modal for Paid To input
                    const modalContent = `
                        <div class="modal fade" id="paidToModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header bg-success text-white">
                                        <h5 class="modal-title">
                                            <i class="fas fa-money-check-alt"></i> Mark as Paid
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label class="form-label">Payment Received By:</label>
                                            <input type="text" class="form-control" id="paidToInput" 
                                                   placeholder="Enter who received the payment" 
                                                   value="${currentPaidTo}">
                                            <div class="form-text">Required when marking as Paid</div>
                                        </div>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> 
                                            This will update both payment status and the "Paid To" field.
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-success" onclick="confirmPaymentUpdate()">
                                            <i class="fas fa-check"></i> Update Payment
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add modal to DOM
                    const modalContainer = document.createElement('div');
                    modalContainer.innerHTML = modalContent;
                    document.body.appendChild(modalContainer);
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('paidToModal'));
                    modal.show();
                    
                    // Wait for modal to be closed
                    return new Promise((resolve) => {
                        // Set up confirm function
                        window.confirmPaymentUpdate = async () => {
                            const paidToValue = document.getElementById('paidToInput').value.trim();
                            if (!paidToValue) {
                                showNotification('Please enter who received the payment', 'warning');
                                return;
                            }
                            
                            paidTo = paidToValue;
                            
                            // Remove modal
                            modal.hide();
                            modalContainer.remove();
                            
                            // Now call the API
                            await callPaymentStatusAPI(newStatus, paidTo);
                            resolve();
                        };
                        
                        // Handle modal close without confirmation
                        document.getElementById('paidToModal').addEventListener('hidden.bs.modal', function() {
                            modalContainer.remove();
                            resolve(); // Resolve without doing anything
                        });
                    });
                } else {
                    // For other statuses (Unpaid, Cash on Delivery), update without Paid To
                    await callPaymentStatusAPI(newStatus, null);
                }
                
            } catch (error) {
                console.error('Error updating payment status:', error);
                showNotification(`Error: ${error.message}`, 'danger');
            }
        }

        // Helper to call payment status API
        async function callPaymentStatusAPI(newStatus, paidTo) {
            try {
                const body = {
                    payment_status: newStatus
                };
                
                if (paidTo) {
                    body.paid_to = paidTo;
                }
                
                // Call the API to update payment status
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/orders/${window.currentOrderId}/payment-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the badge
                    let badgeClass = 'bg-secondary';
                    if (newStatus === 'Paid') {
                        badgeClass = 'bg-success';
                    } else if (newStatus === 'Unpaid') {
                        badgeClass = 'bg-warning text-dark';
                    } else if (newStatus === 'Cash on Delivery') {
                        badgeClass = 'bg-info';
                    }
                    
                    document.getElementById('paymentStatusBadge').className = `badge ${badgeClass} fs-6 p-2`;
                    document.getElementById('paymentStatusBadge').textContent = newStatus;
                    
                    // Update active state of buttons
                    document.querySelectorAll('.card:first-child .btn-group .btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.textContent.includes(newStatus)) {
                            btn.classList.add('active');
                        }
                    });
                    
                    // Also update the Paid To display if provided
                    if (paidTo) {
                        // Check if Paid To display exists, if not create it
                        let paidToDisplay = document.getElementById('paidToDisplay');
                        if (!paidToDisplay) {
                            paidToDisplay = document.createElement('div');
                            paidToDisplay.id = 'paidToDisplay';
                            paidToDisplay.className = 'alert alert-success mt-3';
                            document.getElementById('orderDetailsContent').querySelector('.card:first-child').after(paidToDisplay);
                        }
                        paidToDisplay.innerHTML = `<strong>Payment Received By:</strong> ${paidTo}`;
                    } else if (newStatus !== 'Paid') {
                        // Remove Paid To display if status is not Paid
                        const paidToDisplay = document.getElementById('paidToDisplay');
                        if (paidToDisplay) {
                            paidToDisplay.remove();
                        }
                    }
                    
                    showNotification(`Payment status updated to ${newStatus}`, 'success');
                    
                    // Refresh the orders list after a short delay
                    setTimeout(() => {
                        loadOrders();
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Failed to update status');
                }
                
            } catch (error) {
                console.error('Error updating payment status:', error);
                showNotification(`Error: ${error.message}`, 'danger');
            }
        }

        // Update delivery status
        async function updateDeliveryStatus(newStatus) {
            try {
                if (!window.currentOrderId) {
                    showNotification('No order selected', 'warning');
                    return;
                }
                
                // Call the API to update delivery status
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/orders/${window.currentOrderId}/delivery-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        delivery_status: newStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the badge
                    let badgeClass = 'bg-warning text-dark';
                    if (newStatus === 'Delivered') {
                        badgeClass = 'bg-success';
                    } else if (newStatus === 'Cancelled') {
                        badgeClass = 'bg-danger';
                    } else if (newStatus === 'In Transit') {
                        badgeClass = 'bg-info';
                    }
                    
                    document.getElementById('deliveryStatusBadge').className = `badge ${badgeClass} fs-6 p-2`;
                    document.getElementById('deliveryStatusBadge').textContent = newStatus;
                    
                    // Update active state of buttons
                    document.querySelectorAll('.card:last-child .btn-group .btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.textContent.includes(newStatus)) {
                            btn.classList.add('active');
                        }
                    });
                    
                    showNotification(`Delivery status updated to ${newStatus}`, 'success');
                    
                    // Refresh the orders list after a short delay
                    setTimeout(() => {
                        loadOrders();
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Failed to update status');
                }
                
            } catch (error) {
                console.error('Error updating delivery status:', error);
                showNotification(`Error: ${error.message}`, 'danger');
            }
        }

        // Print order details
        function printOrderDetails() {
            const printContent = document.getElementById('orderDetailsContent').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div class="container mt-4">
                    <h2>Order Invoice - Kuswar Gifts</h2>
                    <hr>
                    ${printContent}
                </div>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
            
            // Re-initialize modal
            const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
            modal.show();
        }

        // Export orders to CSV
        function exportOrders() {
            if (currentFilteredOrders.length === 0) {
                showNotification('No orders to export', 'warning');
                return;
            }
            
            // Create CSV content
            let csv = 'Order ID,Date,Time,Customer Name,Phone,City,Area,Items Count,Total Amount,Payment Status,Delivery Status\n';
            
            currentFilteredOrders.forEach(order => {
                const time = order.OrderTime || order.Ordertime || '';
                const itemsCount = order.items ? order.items.length : 0;
                
                csv += `"${order.OrderID || ''}","${order.OrderDate || ''}","${time}","${order.CustomerName || ''}",`;
                csv += `"${order.Phone || ''}","${order.CustomerCity || ''}","${order.CustomerArea || ''}",`;
                csv += `"${itemsCount}","${order.TotalAmount || 0}","${order.PaymentStatus || ''}","${order.DeliveryStatus || 'Pending'}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `orders_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`Exported ${currentFilteredOrders.length} orders`, 'success');
        }

        // Show loading state
        function showLoading(isLoading) {
            const ordersTable = document.getElementById('ordersTable');
            if (isLoading) {
                ordersTable.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading orders...</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Create toast element
            const toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.id = toastId;
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            document.body.appendChild(toastContainer);
            
            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 3000
            });
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', function() {
                toastContainer.remove();
            });
        }

        // Make functions available globally
        window.loadOrders = loadOrders;
        window.filterOrders = filterOrders;
        window.clearFilters = clearFilters;
        window.setFilter = setFilter;
        window.viewOrderDetails = viewOrderDetails;
        window.updatePaymentStatus = updatePaymentStatus;
        window.updateDeliveryStatus = updateDeliveryStatus;
        window.printOrderDetails = printOrderDetails;
        window.exportOrders = exportOrders;
    </script>
</body>
</html>